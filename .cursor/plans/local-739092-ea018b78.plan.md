<!-- ea018b78-c1e0-45b4-a736-2a42a71d83e4 9b8c362a-1263-4794-a2a2-2c64ea6e7dbc -->
# LocalModelCache Credential Support and ClusterStorageContainer Removal

## Problem Statement

Currently, caching a model using `LocalModelCache` requires:

1. Creating a `ClusterStorageContainer` CRD with `workloadType: localModelDownloadJob` to specify the download job container
2. Embedding credentials (e.g., HF token) in the `ClusterStorageContainer` container spec via env vars from secrets
3. Creating secrets in the `kserve-localmodel-jobs` namespace

This is cumbersome and inconsistent with how `InferenceService` specifies credentials.

## Proposed Solution

### 1. CRD Changes to LocalModelCacheSpec

Add credential specification fields to [`pkg/apis/serving/v1alpha1/local_model_cache_types.go`](pkg/apis/serving/v1alpha1/local_model_cache_types.go):

```go
type LocalModelCacheSpec struct {
    SourceModelUri string              `json:"sourceModelUri" validate:"required"`
    ModelSize      resource.Quantity   `json:"modelSize" validate:"required"`
    NodeGroups     []string            `json:"nodeGroups" validate:"required"`
    
    // NEW: ServiceAccountName for credential lookup (like InferenceService)
    // +optional
    ServiceAccountName string `json:"serviceAccountName,omitempty"`
    
    // NEW: Storage configuration for credentials
    // +optional
    Storage *StorageSpec `json:"storage,omitempty"`
}

// StorageSpec mirrors InferenceService StorageSpec
type StorageSpec struct {
    // The Storage Key in the secret for this object
    // +optional
    StorageKey *string `json:"key,omitempty"`
    
    // Parameters to override default storage credentials/config
    // +optional
    Parameters *map[string]string `json:"parameters,omitempty"`
}
```

### 2. LocalModelInfo Changes

Update [`pkg/apis/serving/v1alpha1/local_model_node_types.go`](pkg/apis/serving/v1alpha1/local_model_node_types.go) to propagate credential info:

```go
type LocalModelInfo struct {
    SourceModelUri     string       `json:"sourceModelUri" validate:"required"`
    ModelName          string       `json:"modelName" validate:"required"`
    
    // NEW: Credential configuration
    ServiceAccountName string       `json:"serviceAccountName,omitempty"`
    Storage            *StorageSpec `json:"storage,omitempty"`
}
```

### 3. Controller Changes

Modify [`pkg/controller/v1alpha1/localmodelnode/controller.go`](pkg/controller/v1alpha1/localmodelnode/controller.go):

**a) Replace `getContainerSpecForStorageUri` with StorageInitializerConfig-based approach:**

```go
func (c *LocalModelNodeReconciler) getContainerSpec(ctx context.Context, storageConfig *types.StorageInitializerConfig) *corev1.Container {
    return &corev1.Container{
        Name:  DownloadContainerName,
        Image: storageConfig.Image,
        TerminationMessagePolicy: corev1.TerminationMessageFallbackToLogsOnError,
        Resources: corev1.ResourceRequirements{
            Limits: map[corev1.ResourceName]resource.Quantity{
                corev1.ResourceCPU:    resource.MustParse(storageConfig.CpuLimit),
                corev1.ResourceMemory: resource.MustParse(storageConfig.MemoryLimit),
            },
            Requests: map[corev1.ResourceName]resource.Quantity{
                corev1.ResourceCPU:    resource.MustParse(storageConfig.CpuRequest),
                corev1.ResourceMemory: resource.MustParse(storageConfig.MemoryRequest),
            },
        },
    }
}
```

**b) Add credential injection using CredentialBuilder:**

```go
func (c *LocalModelNodeReconciler) injectCredentials(ctx context.Context, container *corev1.Container, 
    volumes *[]corev1.Volume, modelInfo v1alpha1.LocalModelInfo) error {
    
    if modelInfo.Storage != nil && modelInfo.Storage.StorageKey != nil {
        // Use storage spec credentials
        var params map[string]string
        if modelInfo.Storage.Parameters != nil {
            params = *modelInfo.Storage.Parameters
        }
        return c.credentialBuilder.CreateStorageSpecSecretEnvs(
            jobNamespace, nil, *modelInfo.Storage.StorageKey, params, container)
    }
    
    // Use service account credentials
    return c.credentialBuilder.CreateSecretVolumeAndEnv(
        jobNamespace, nil, modelInfo.ServiceAccountName, container, volumes)
}
```

### 4. LocalModel Controller Changes

Update [`pkg/controller/v1alpha1/localmodel/controller.go`](pkg/controller/v1alpha1/localmodel/controller.go) to propagate credential info to LocalModelNode:

```go
func (c *LocalModelReconciler) ReconcileLocalModelNode(...) {
    // Propagate credential info from LocalModelCache to LocalModelNode
    localModelInfo := v1alpha1.LocalModelInfo{
        SourceModelUri:     localModel.Spec.SourceModelUri,
        ModelName:          localModel.Name,
        ServiceAccountName: localModel.Spec.ServiceAccountName,
        Storage:            localModel.Spec.Storage,
    }
    // ... add to LocalModelNode spec
}
```

## Credential Specification Methods (Matching InferenceService)

Users can specify credentials in three ways:

### Method 1: ServiceAccountName

```yaml
apiVersion: serving.kserve.io/v1alpha1
kind: LocalModelCache
metadata:
  name: llama3-8b
spec:
  sourceModelUri: "hf://meta-llama/Meta-Llama-3-8B"
  modelSize: 10Gi
  nodeGroups: ["workers"]
  serviceAccountName: hf-downloader  # SA with HF token secret attached
```

### Method 2: Storage Key Reference

```yaml
apiVersion: serving.kserve.io/v1alpha1
kind: LocalModelCache
metadata:
  name: llama3-8b
spec:
  sourceModelUri: "hf://meta-llama/Meta-Llama-3-8B"
  modelSize: 10Gi
  nodeGroups: ["workers"]
  storage:
    key: hf-credentials  # Key in storage-config secret
```

### Method 3: Inline Parameters

```yaml
apiVersion: serving.kserve.io/v1alpha1
kind: LocalModelCache
metadata:
  name: s3-model
spec:
  sourceModelUri: "s3://bucket/model"
  modelSize: 5Gi
  nodeGroups: ["workers"]
  storage:
    key: my-s3-key
    parameters:
      type: s3
      region: us-west-2
```

## Files to Modify

| File | Changes |

|------|---------|

| [`pkg/apis/serving/v1alpha1/local_model_cache_types.go`](pkg/apis/serving/v1alpha1/local_model_cache_types.go) | Add `ServiceAccountName` and `Storage` fields |

| [`pkg/apis/serving/v1alpha1/local_model_node_types.go`](pkg/apis/serving/v1alpha1/local_model_node_types.go) | Add credential fields to `LocalModelInfo` |

| [`pkg/controller/v1alpha1/localmodelnode/controller.go`](pkg/controller/v1alpha1/localmodelnode/controller.go) | Use StorageInitializerConfig, inject credentials |

| [`pkg/controller/v1alpha1/localmodel/controller.go`](pkg/controller/v1alpha1/localmodel/controller.go) | Propagate credential info to LocalModelNode |

| [`config/crd/`](config/crd/) | Regenerate CRD manifests |

## Migration Notes

- `ClusterStorageContainer` with `workloadType: localModelDownloadJob` becomes optional (backward compatible)
- Existing LocalModelCache resources without credentials continue to work using default storage-initializer
- New credential fields are optional

### To-dos

- [ ] Update LocalModelCacheSpec and LocalModelInfo with credential fields
- [ ] Update controller to use StorageInitializerConfig and inject credentials
- [ ] Propagate credential info from LocalModelCache to LocalModelNode
- [ ] Run code generation for CRDs and deep copy functions
- [ ] Add unit tests for credential injection in download jobs
- [ ] Update documentation with new credential specification methods