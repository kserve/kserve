apiVersion: serving.kserve.io/v1alpha1
kind: LLMInferenceServiceConfig
metadata:
  name: kserve-config-llm-scheduler
spec:
  router:
    scheduler:
      pool:
        spec:
          extensionRef:
            failureMode: FailClose
            kind: Service
            name: |-
              {{ ChildName .ObjectMeta.Name `-epp-service` }}
          selector: {}
          targetPortNumber: 8000
      template:
        containers:
          - name: main
            ports:
              - containerPort: 9002
                name: grpc
                protocol: TCP
              - containerPort: 9003
                name: grpc-health
                protocol: TCP
              - containerPort: 9090
                name: metrics
                protocol: TCP
            image: ghcr.io/llm-d/llm-d-inference-scheduler:0.0.4
            imagePullPolicy: IfNotPresent
            livenessProbe:
              failureThreshold: 3
              grpc:
                port: 9003
                service: envoy.service.ext_proc.v3.ExternalProcessor
              initialDelaySeconds: 5
              periodSeconds: 10
              successThreshold: 1
              timeoutSeconds: 1
            readinessProbe:
              failureThreshold: 3
              grpc:
                port: 9003
                service: envoy.service.ext_proc.v3.ExternalProcessor
              initialDelaySeconds: 30
              periodSeconds: 10
              successThreshold: 1
              timeoutSeconds: 1
            args:
              - --poolName
              - "{{ ChildName .ObjectMeta.Name `-inference-pool` }}"
              - --poolNamespace
              - "{{ .ObjectMeta.Namespace }}"
              - --zap-encoder
              - json
              - --grpcPort
              - "9002"
              - --grpcHealthPort
              - "9003"
            env:
              - name: ENABLE_LOAD_AWARE_SCORER
                value: "true"
              - name: ENABLE_PREFIX_AWARE_SCORER
                value: "true"
              - name: ENABLE_SESSION_AWARE_SCORER
                value: "true"
              - name: LOAD_AWARE_SCORER_WEIGHT
                value: "1"
              - name: PD_ENABLED
                value: "true"
              - name: PD_PROMPT_LEN_THRESHOLD
                value: "10"
              - name: PREFILL_ENABLE_LOAD_AWARE_SCORER
                value: "true"
              - name: PREFILL_ENABLE_PREFIX_AWARE_SCORER
                value: "true"
              - name: PREFILL_ENABLE_SESSION_AWARE_SCORER
                value: "true"
              - name: PREFILL_LOAD_AWARE_SCORER_WEIGHT
                value: "1"
              - name: PREFILL_PREFIX_AWARE_SCORER_WEIGHT
                value: "1"
              - name: PREFILL_SESSION_AWARE_SCORER_WEIGHT
                value: "1"
              - name: PREFIX_AWARE_SCORER_WEIGHT
                value: "2"
              - name: SESSION_AWARE_SCORER_WEIGHT
                value: "1"
            resources:
              requests:
                cpu: 256m
                memory: 500Mi
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: FallbackToLogsOnError
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              capabilities:
                drop:
                  - ALL
              seccompProfile:
                type: RuntimeDefault
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        terminationGracePeriodSeconds: 30
