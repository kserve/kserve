name: LLMInferenceService E2E Tests

on:
  pull_request:
    paths:
      - "pkg/apis/serving/v1alpha1/llm*"
      - "pkg/apis/serving/v1alpha2/llm*"
      - "pkg/controller/v1alpha1/llmisvc/**"
      - "pkg/controller/v1alpha2/llmisvc/**"
      - "config/llmisvc/**"
      - "config/rbac/llmisvc/**"
      - "cmd/llmisvc/**"
      - "test/e2e/llmisvc/**"
      - ".github/workflows/e2e-test-llmisvc.yaml"
      - "hack/setup/quick-install/llmisvc-dependency-install.sh"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TAG: ${{ github.sha }}
  DOCKER_IMAGES_PATH: "/mnt/docker-images"
  KO_DOCKER_REPO: "kserve"
  LLMISVC: "true"

jobs:
  
  llmisvc-image-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Load KServe environment variables
        run: ./kserve-images.sh --ci

      - name: Free-up disk space
        uses: ./.github/actions/free-up-disk-space

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          cache-binary: true
          
      - name: Build LLMISvc image
        run: |
          sudo mkdir -p ${DOCKER_IMAGES_PATH}
          sudo chown -R $USER ${DOCKER_IMAGES_PATH}
          ./test/scripts/gh-actions/build-images.sh llmisvc
          docker image ls
          sudo ls -lh ${DOCKER_IMAGES_PATH}
      
      - name: Upload LLMISvc controller image
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.LLMISVC_CONTROLLER_IMG }}-${{ env.TAG }}
          path: ${{ env.DOCKER_IMAGES_PATH }}/${{ env.LLMISVC_CONTROLLER_IMG }}-${{ env.TAG }}
          compression-level: 0
          if-no-files-found: error
          
  test-llmisvc:
    runs-on: ubuntu-latest
    needs: [llmisvc-image-build]
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Load KServe environment variables
        run: ./kserve-images.sh --ci
        
      - name: Free-up disk space
        uses: ./.github/actions/free-up-disk-space

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Setup Minikube
        uses: ./.github/actions/minikube-setup
          
      - name: Download LLMISvc controller image
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.LLMISVC_CONTROLLER_IMG }}-${{ env.TAG }}
          path: ./tmp

      - name: Load LLMISvc controller image into minikube
        run: |          
          # Load the tagged image into minikube
          minikube image load ./tmp/${{ env.LLMISVC_CONTROLLER_IMG }}-${{ env.TAG }}

          # Verify image is loaded
          echo "Images in minikube:"
          minikube image ls | grep ${{ env.LLMISVC_CONTROLLER_IMG }} || echo "No llmisvc-controller images found"

      - name: KServe dependency setup
        uses: ./.github/actions/kserve-dep-setup
        with:
          deploy-llmisvc: "true"

      - name: Install UV
        run: ./test/scripts/gh-actions/setup-uv.sh

      - name: Install KServe
        run: |          
          ./test/scripts/gh-actions/setup-kserve.sh

      - name: Verify LLMISvc setup
        run: |
          echo "ðŸ” Verifying LLMISvc controller setup..."

          echo "ðŸ“‹ LLMISvc Controller:"
          kubectl get pods -n kserve -l app.kubernetes.io/component=controller || true

          echo "ðŸ“‹ LLM Resources:"
          kubectl get llminferenceserviceconfigs -A || true

          echo "ðŸ“‹ Gateway API Resources:"
          kubectl get crd | grep inference || true

          echo "ðŸ“‹ Envoy Gateway:"
          kubectl get pods -n envoy-gateway-system || true

          echo "ðŸ“‹ AI Gateway:"
          kubectl get pods -n envoy-ai-gateway-system || true

          echo "âœ… LLMISvc setup verification complete!"

      - name: Run predictor E2E tests
        timeout-minutes: 40
        run: |
          # Run only CPU tests for now using pytest markers (cluster_)
          # Available GPU vendors: amd, nvidia, intel
          ./test/scripts/gh-actions/run-e2e-tests.sh "llminferenceservice and cluster_cpu" 1 "envoy-gateway"

      - name: Check system status
        if: always()
        run: |
          echo "ðŸ” Enhanced LLMISvc system status check..."

          echo "ðŸ“‹ LLMISvc Controller:"
          kubectl get pods -n kserve -l app.kubernetes.io/component=controller || true
          kubectl describe pods -n kserve -l app.kubernetes.io/component=controller || true

          echo "ðŸ“‹ LLM Resources:"
          kubectl get llminferenceservices -A || true
          kubectl get llminferenceserviceconfigs -A || true
          kubectl get inferencepools -A || true
          kubectl get inferenceobjectives -A || true

          echo "ðŸ“‹ Gateway API Resources:"
          kubectl get gateways -A || true
          kubectl get httproutes -A || true

          echo "ðŸ“‹ Webhook Configurations:"
          kubectl get validatingwebhookconfiguration | grep llm || true

          echo "ðŸ“‹ Recent Events:"
          kubectl get events -A --sort-by='.lastTimestamp' | tail -20 || true

          echo "ðŸ“‹ Controller Logs:"
          kubectl logs -n kserve -l app.kubernetes.io/component=controller --tail=50 || true
  
      # For debugging purposes
      # - name: Collect comprehensive pod logs
      #   if: always()
      #   run: |
      #     kubectl get gateways -A -o yaml
      #     kubectl get httproutes -A
      #     kubectl get httproute -n kserve-ci-e2e-test -o yaml
      #     kubectl get inferencepools -A     
      #     kubectl get inferencepools -n kserve-ci-e2e-test -o yaml
      #     kubectl get llmisvc -n kserve-ci-e2e-test -o yaml      
      #     kubectl get gatewayclasses -A
      #     kubectl get services -n envoy-gateway-system
      #     kubectl get svc -A
      #     kubectl get certificate -A
      #     kubectl get pods -A
      #     kubectl get event -n kserve
      #     kubectl get event -n kserve-ci-e2e-test          
      #     kubectl get event -n envoy-gateway-system
      #     kubectl get event -n envoy-ai-gateway-system
          
      #     echo "ðŸ“‹ Collecting comprehensive pod logs..."

      #     # Key namespaces for LLMISvc
      #     NAMESPACES="envoy-gateway-system envoy-ai-gateway-system kserve kserve-ci-e2e-test"

      #     for ns in $NAMESPACES; do
      #       if ! kubectl get namespace $ns &>/dev/null; then
      #         echo "âš ï¸ Namespace $ns does not exist, skipping..."
      #         continue
      #       fi

      #       echo "=== Namespace: $ns ==="

      #       for pod in $(kubectl get pods -n $ns -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
      #         echo "--- Pod: $pod ---"
      #         kubectl logs -n $ns $pod --all-containers=true --tail=1000 2>&1 || true
      #         echo ""
      #       done
      #     done

      #     echo "ðŸ“‹ Describing LLMInferenceServices..."
      #     for llmisvc in $(kubectl get llminferenceservices -n kserve-ci-e2e-test -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
      #       echo "=== LLMInferenceService: $llmisvc ==="
      #       kubectl describe llminferenceservices -n kserve-ci-e2e-test $llmisvc 2>&1 || true
      #     done 
        
